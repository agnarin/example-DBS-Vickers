# อธิบายโครงสร้าง Balance

-   **`SettledBalance` (ยอดเงินที่ชำระแล้ว)** คือยอดเงินสดจริงที่ผ่านกระบวนการชำระราคา (Settlement) และเข้าบัญชีลูกค้าเรียบร้อยแล้ว (เช่น เงิน 20,000 USD จากการขาย Bond ที่เข้าตอนตี 1) เงินส่วนนี้เป็นฐานในการคำนวณสิทธิ์ทุกอย่าง
        
-   **`EarmarkedBalance` (ยอดเงินที่กันไว้)** คือส่วนหนึ่งของ `settledBalance` ที่ถูก "จอง" หรือ "กัน" ไว้สำหรับธุรกรรมที่ส่งคำสั่งแล้วแต่ยังไม่ถึงเวลาตัดเงิน (Debit) เช่น คำสั่งซื้อ Structure Notes (รอตัดเงิน 13:00) หรือคำสั่งถอนเงินที่รอการดำเนินการเงินส่วนนี้ **ไม่สามารถ** นำไปใช้ซ้ำได้
     
-   **`unsettledBalance` (ยอดเงินที่รอชำระ)** คือยอดเงินที่กำลังจะเข้าในอนาคต แต่ยังไม่ถึงวัน Settlement ยอดนี้ _ไม่นำมาคำนวณ_ ยอดที่ถอนได้


### สูตรการคำนวณยอดที่ถอนได้ (Available for Withdrawal)

    Available for Withdrawal = Settled Balance - Earmarked Balance

## อธิบายผลลัพธ์ในแต่ละ Scenarios

### สถานะเริ่มต้น (ณ 01:00 วันนี้)

-   **เหตุการณ์:** (Scenario 1) เงิน 20,000 USD จากการขาย Offshore Bonds (เมื่อ T-2) เครดิตเข้าบัญชีลูกค้า (ตามเงื่อนไข T+2 @ ตี 1)
    
-   **การทำงานของระบบ:** `account.creditSettledBalance(new BigDecimal("20000.00"))`
    
-   **สถานะบัญชี @ 01:01:**
    
    ```
    settledBalance: 20,000.00
    earmarkedBalance: 0.00
    Available for Withdrawal: 20,000.00
    
    ```
    

### Scenario @ 08:00 (ลูกค้าซื้อ Offshore Structure Notes)

-   **เหตุการณ์:** (Scenario 2) ลูกค้าทำรายการซื้อ Offshore Structure Notes 1 หน่วย (NAV = 9,000 USD)
    
-   **การทำงานของระบบ:** ระบบเรียกฟังก์ชัน `account.earmarkForPurchase(new BigDecimal("9000.00"))`
    
-   **การตรวจสอบ:**
    
    1.  `getAvailableBalance()` คืนค่า **20,000.00**
        
    2.  เงื่อนไข `9000.00 <= 20000.00` เป็น **True**
        
    3.  `earmarkedBalance` เพิ่มขึ้น 9,000.00
        
-   **ผลลัพธ์:**
    
    -   คำสั่งซื้อ **สำเร็จ (Accepted)**
        
    -   เงินจำนวน 9,000 USD ถูกกัน (Earmark) ไว้เพื่อรอตัดบัญชีจริง (Debit) ณ เวลา 13:00
        
-   **สถานะบัญชี @ 08:01:**
    
    ```
    settledBalance: 20,000.00
    earmarkedBalance: 9,000.00
    Available for Withdrawal: 11,000.00
    
    ```
    

### Scenario @ 11:00 (ลูกค้าสั่งถอนเงิน)

-   **เหตุการณ์:** (Scenario 3) ลูกค้าสั่งถอนเงิน 20,000 USD
    
-   **การทำงานของระบบ:** ระบบเรียกฟังก์ชัน `account.reserveForWithdrawal(new BigDecimal("20000.00"))`
    
-   **การตรวจสอบ:**
    
    1.  `getAvailableBalance()` คืนค่า **11,000.00** (จากสถานะล่าสุด @ 08:01)
        
    2.  เงื่อนไข `20000.00 <= 11000.00` เป็น **False**
        
-   **ผลลัพธ์:**
    
    -   คำสั่งถอนเงิน **ถูกปฏิเสธ (Rejected)** ❌
        
-   **เหตุผล:** ระบบทำงานถูกต้องโดยปฏิเสธการถอนเงิน แม้ว่า `settledBalance` (20,000) จะเท่ากับยอดถอน แต่ยอดเงินที่ _ใช้ได้จริง_ (Available) เหลือเพียง 11,000 USD เนื่องจาก 9,000 USD ได้ถูก _Earmark_ ไว้สำหรับคำสั่งซื้อ Structure Notes (ตอน 08:00) ที่กำลังรอตัดเงินตอน 13:00 แล้ว
